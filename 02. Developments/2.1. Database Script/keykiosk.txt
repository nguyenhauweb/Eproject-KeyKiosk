-- Open Sql Server -> New Query -> Execute
-- Create the database if it doesn't exist
IF NOT EXISTS (SELECT * FROM sys.databases WHERE name = 'keykiosk')
BEGIN
    CREATE DATABASE keykiosk;
END
GO

USE keykiosk;
GO

-- Drop foreign key constraints
DECLARE @sql NVARCHAR(MAX) = '';

SELECT @sql = @sql + 'ALTER TABLE ' + QUOTENAME(OBJECT_SCHEMA_NAME(parent_object_id)) + '.' + QUOTENAME(OBJECT_NAME(parent_object_id)) + 
                   ' DROP CONSTRAINT ' + QUOTENAME(name) + ';' + CHAR(13)
FROM sys.foreign_keys
WHERE referenced_object_id IN (
    OBJECT_ID('dbo.accounts'),
    OBJECT_ID('dbo.categories'),
    OBJECT_ID('dbo.product_types'),
    OBJECT_ID('dbo.products'),
    OBJECT_ID('dbo.orders'),
    OBJECT_ID('dbo.permissions')
);

-- Execute the dynamic SQL to drop foreign key constraints
EXEC sp_executesql @sql;

-- Drop existing tables if they exist
IF OBJECT_ID('dbo.accounts', 'U') IS NOT NULL
    DROP TABLE dbo.accounts;
IF OBJECT_ID('dbo.categories', 'U') IS NOT NULL
    DROP TABLE dbo.categories;
IF OBJECT_ID('dbo.product_types', 'U') IS NOT NULL
    DROP TABLE dbo.product_types;
IF OBJECT_ID('dbo.products', 'U') IS NOT NULL
    DROP TABLE dbo.products;
IF OBJECT_ID('dbo.images', 'U') IS NOT NULL
    DROP TABLE dbo.images;
IF OBJECT_ID('dbo.orders', 'U') IS NOT NULL
    DROP TABLE dbo.orders;
IF OBJECT_ID('dbo.software_accounts', 'U') IS NOT NULL
    DROP TABLE dbo.software_accounts;
IF OBJECT_ID('dbo.software_license_keys', 'U') IS NOT NULL
    DROP TABLE dbo.software_license_keys;
IF OBJECT_ID('dbo.verification_code', 'U') IS NOT NULL
    DROP TABLE dbo.verification_code;
IF OBJECT_ID('dbo.permissions', 'U') IS NOT NULL
    DROP TABLE dbo.permissions;

-- Recreate tables
CREATE TABLE dbo.accounts
(
    account_id    BIGINT IDENTITY PRIMARY KEY,
    balance       NUMERIC(38, 2),
    email         VARCHAR(255) NOT NULL CONSTRAINT UK_n7ihswpy07ci568w34q0oi8he UNIQUE,
    full_name     NVARCHAR(255) NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    role          VARCHAR(255) NOT NULL,
    status        VARCHAR(255) NOT NULL,
    username      VARCHAR(255) NOT NULL CONSTRAINT UK_k8h1bgqoplx0rkngj01pm1rgp UNIQUE
);

INSERT INTO dbo.accounts (balance, email, full_name, password_hash, role, status, username) VALUES (0.00, N'hoangthai229@gmail.com', N'Hoàng Thái', N'$2a$10$d5gTL4DprhTt0oa43dTMxOxL7KnjngY7kbl4zxhD21geP9MOjraNS', N'ADMIN', N'ACTIVE', N'hoangthai229');
INSERT INTO dbo.accounts (balance, email, full_name, password_hash, role, status, username) VALUES (0.00, N'thilaphaixanh2806@gmail.com', N'Phạm Tuyên', N'$2a$10$RlTozgMOh8mZk6m2.k5ud.LqLSl0QblP0EaljkQOex6QuGgiAXoc.', N'ADMIN', N'ACTIVE', N'thilaphaixanh2806');
INSERT INTO dbo.accounts (balance, email, full_name, password_hash, role, status, username) VALUES (0.00, N'datgau1204@gmail.com', N'Nguyễn Tiến Đạt', N'$2a$10$L0qAI65hoa1FAxpmVQXat.wLLs0YZn/FzVGLFCaONLDb6b9s9p0Bu', N'ADMIN', N'ACTIVE', N'datgau1204');
INSERT INTO dbo.accounts (balance, email, full_name, password_hash, role, status, username) VALUES (0.00, N'nguyenhauweb@gmail.com', N'admin', N'$2a$10$uaGzdk8fcuHLxNFSeU06KutADtqu7JqHziGx3.EDqt2zEPXfxnyUi', N'ADMIN', N'ACTIVE', N'admin');
INSERT INTO dbo.accounts (balance, email, full_name, password_hash, role, status, username) VALUES (0.00, N'seller@gmail.com', N'seller', N'$2a$10$bel8w20afillqXq7SYVpW.M8nFTp04e9pHtBqiHiv6wIBa.e8A1iW', N'SELLER', N'ACTIVE', N'seller');

CREATE TABLE dbo.categories
(
    category_id BIGINT IDENTITY PRIMARY KEY,
    description VARCHAR(255),
    name        VARCHAR(255) NOT NULL,
    status      VARCHAR(255) NOT NULL,
    account_id  BIGINT CONSTRAINT FKqkk6erxi4k4kpk027kr1sc73t REFERENCES dbo.accounts
);

CREATE TABLE dbo.product_types
(
    type_id     BIGINT IDENTITY PRIMARY KEY,
    name        VARCHAR(255) NOT NULL,
    account_id  BIGINT NOT NULL CONSTRAINT FKegwsatqj0y1awi6s9tdy0786m REFERENCES dbo.accounts,
    category_id BIGINT NOT NULL CONSTRAINT FKa7yy714aqb81yhfjpselilofs REFERENCES dbo.categories
);

CREATE TABLE dbo.products
(
    product_id  BIGINT IDENTITY PRIMARY KEY,
    description VARCHAR(255),
    name        VARCHAR(255) NOT NULL,
    price       NUMERIC(38, 2) NOT NULL,
    quantity    INT NOT NULL,
    status      VARCHAR(255) NOT NULL,
    account_id  BIGINT NOT NULL CONSTRAINT FKo2rylt6mcejmncffge166tl30 REFERENCES dbo.accounts,
    type_id     BIGINT NOT NULL CONSTRAINT FK98l10qwb1l2ywp1d24x1d3ef2 REFERENCES dbo.product_types
);

CREATE TABLE dbo.images
(
    image_id    BIGINT IDENTITY PRIMARY KEY,
    file_name   VARCHAR(255),
    file_size   VARCHAR(255),
    image_type  VARCHAR(255) NOT NULL,
    image_url   VARCHAR(255),
    account_id  BIGINT CONSTRAINT FKe21gm4ia851bfavsak0fea92t REFERENCES dbo.accounts,
    category_id BIGINT CONSTRAINT FKbs9q39413hnr6t0k0vy79uj3b REFERENCES dbo.categories,
    product_id  BIGINT CONSTRAINT FKghwsjbjo7mg3iufxruvq6iu3q REFERENCES dbo.products
);

CREATE TABLE dbo.orders
(
    order_id       BIGINT IDENTITY PRIMARY KEY,
    order_date     DATETIME2(6) NOT NULL,
    order_status   VARCHAR(255) NOT NULL,
    payment_method VARCHAR(255) NOT NULL,
    quantity       INT NOT NULL,
    total_amount   NUMERIC(38, 2) NOT NULL,
    account_id     BIGINT NOT NULL CONSTRAINT FKagh5svlor3slbay6tq5wqor1o REFERENCES dbo.accounts,
    product_id     BIGINT NOT NULL CONSTRAINT FKkp5k52qtiygd8jkag4hayd0qg REFERENCES dbo.products
);

CREATE TABLE dbo.software_accounts
(
    software_account_id BIGINT IDENTITY PRIMARY KEY,
    account_info        VARCHAR(255) NOT NULL,
    payment_status      VARCHAR(255) NOT NULL,
    status              VARCHAR(255) NOT NULL,
    account_id          BIGINT NOT NULL CONSTRAINT FKox967ton61fl41039b453neq0 REFERENCES dbo.accounts,
    product_id          BIGINT NOT NULL CONSTRAINT FK1wn5ewx9sqv2sydrkaor8fn59 REFERENCES dbo.products
);

CREATE TABLE dbo.software_license_keys
(
    license_id     BIGINT IDENTITY PRIMARY KEY,
    license_key    VARCHAR(255) NOT NULL,
    payment_status VARCHAR(255) NOT NULL,
    status         VARCHAR(255) NOT NULL,
    account_id     BIGINT NOT NULL CONSTRAINT FKe01vcrkgmxovfypqsbwthgftc REFERENCES dbo.accounts,
    product_id     BIGINT NOT NULL CONSTRAINT FKfydpi4kqk7u3mcy8hu0kkc414 REFERENCES dbo.products
);

CREATE TABLE dbo.verification_code
(
    verification_code_id BIGINT IDENTITY PRIMARY KEY,
    code                 VARCHAR(255),
    email                VARCHAR(255),
    account_id           BIGINT CONSTRAINT FKjy53tw228oda94k4d99rcuvc8 REFERENCES dbo.accounts
);

CREATE TABLE dbo.permissions
(
    permission_id   BIGINT IDENTITY PRIMARY KEY,
    permission_type VARCHAR(255),
    account_id      BIGINT NOT NULL CONSTRAINT FKp6c9fhqxlx8d8u920x1qfuyig REFERENCES dbo.accounts
);
